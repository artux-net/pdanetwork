name: Deploy

on:
  push:
    branches:
      - master
  workflow_dispatch:
    inputs:
      tag:
        type: string
        description: Tag of docker image to deploy (use 'master' to build new)
        default: master
        required: true
      profile:
        type: choice
        description: Profile to deploy
        default: dev
        options:
          - prod
          - dev

jobs:
  test:
    name: Test
    uses: ./.github/workflows/test.yml

  backup-db:
    name: Backup DB
    uses: ./.github/workflows/backup.yml

  build:
    needs: test
    uses: ./.github/workflows/build.yml
    name: 'Build and upload artifact'

  deploy:
    needs:
      - build
      - backup-db

    name: 'Deploy on server'
    uses: ./.github/workflows/deploy.yml
    with:
      tag: ${{ github.event.inputs.tag }}
      profile: ${{ github.event.inputs.profile }}
