name: ⚙️Backup database

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_call:
  workflow_dispatch:

jobs:
  dump:
    runs-on: self-hosted
    name: 'Dump Backup'
    steps:
      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y-%m-%dT%H-%M-%S')" >> $GITHUB_ENV

      - name: Postgres Dump Backup
        run: |
          mkdir src
          pg_dump -U pdanet -f src/backup.sql --no-owner --no-privileges

      - uses: ryand56/r2-upload-action@latest
        with:
          r2-account-id: ${{ secrets.R2_ACCOUNT_ID }}
          r2-access-key-id: ${{ secrets.R2_ACCESS_KEY_ID }}
          r2-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          r2-bucket: ${{ secrets.R2_BUCKET }}
          source-dir: src
          destination-dir: ./${{ env.date }}
